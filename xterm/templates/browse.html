<!doctype html>
<html lang="en">

<head>
  <style>
    .xterm-viewport {
      overflow: hidden !important;
    }
  </style>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/xterm@3.6.0/dist/xterm.css" />

  <script src="https://unpkg.com/xterm@3.6.0/dist/xterm.js"></script>
  <script src="https://unpkg.com/xterm@3.6.0/dist/addons/fit/fit.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.3/socket.io.js"></script>
  <title>Docker Hub</title>
</head>

<body>

  <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand sm">Docker on Demand V2</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="/containers/">Containers</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/images/">Images</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/browse/">Docker Hub</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">

    <form id="tfnewsearch" method="get" class="row g-3 my-3 ms-sm-3 justify-content-center ">
      <div class="col-sm-6 col-9">
        <input id="my_text" type="text" name="q" value="{{q}}" class="form-control" id="inputPassword2"
          placeholder="Search Images on Docker Hub">
      </div>
      <div class="col-sm-1 col-3">
        <button type="submit" class="btn btn-primary mb-3">Search</button>
      </div>
    </form>

    <!----->

    {% for item in summary %}
    {% if item.certification_status != "certified" %}
    <div class="d-flex justify-content-center ">
      <div class="d-flex border-start border-primary border-5 p-4 shadow-lg  mb-4 bg-body rounded col-sm-8 col-12">

        <div class="flex-shrink-0 me-4 align-self-center">
          <img src="https://d1q6f0aelx0por.cloudfront.net/product-logos/library-{{item.name}}-logo.png?"
            onerror="this.onerror=null; this.src='../static/assets/img/docker_img.png'" alt="" width="60px"
            height="60px">

        </div>

        <div class="col d-flex flex-column">
          <h5>{{ item.name }}</h5>
          <p>{{ item.short_description }}</p>
        </div>

        <!--d-flex col align-content-around justify-content-start justify-content-md-end -->
        <div class="flex-shrink-0 d-flex  justify-content-center ms-2 ">

          <div class="align-self-end">
            <button type="button" class="btn btn-md btn-primary text-nowrap" data-bs-toggle="modal" data-bs-target="#exampleModal"
              data-bs-name="{{item.name}}">
              Pull
            </button>

          </div>

        </div>
      </div>
    </div>

    {% endif %}
    {% endfor %}

  </div>




  <!-- Modal -->
  <div class="modal fade" id="exampleModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <!--<h5 class="modal-title" id="exampleModalLabel">New message</h5> -->
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <div class="d-flex">


            <div class="d-flex justify-content-center col-6 align-items-center row g-2 ">
              <div class="col-auto">
                <label for="imageName" class="col-form-label">Image name: </label>
              </div>
              <div class="col-auto">
                <input id="modal_input" class="form-control" type="text" readonly />
              </div>
            </div>

            <div class="d-flex justify-content-center col-6 align-items-center row g-2">
              <div class="col-auto">
                <label class="col-form-label">Version: </label>
              </div>

              <div class="col-auto">
                <input id="modal_input_version" class="form-control" type="text" placeholder="latest" />
              </div>

            </div>
          </div>

          <div class="d-flex mt-3 justify-content-center">
            <button id="myBtn2" onclick="pull_image()" class="btn btn-primary">Pull</button>
          </div>

          <div class="py-2 ps-2 pe-3 d-none" style="background-color: black;" id="terminal"></div>

        </div>

        <div class="d-none mb-3 justify-content-evenly" id="modal_footer">
          <div>
            <button id="myBtn3" onclick="window.location.href = '/containers/'" class="btn btn-primary btn-md">Go To Containers</button>
          </div>
          <div>
            <button id="myBtn4" onclick="window.location.href = '/images/'" class="btn btn-primary btn-md">Go To Images</button>
          </div>
          <div>
            <button id="myBtn5" onclick="hide_all()" data-bs-dismiss="modal" class="btn btn-primary">Continue browsing</button>
          </div>
        </div>



      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>

  <!-- for actice highlight but for now uselss -->
  <script type="text/javascript">
    $(document).ready(function () {
      var url = window.location;
      $('ul.nav a[href="' + url + '"]').parent().addClass('active');
      $('ul.nav a').filter(function () {
        return this.href == url;
      }).parent().addClass('active');
    });
  </script>


  <script type="text/javascript">
    var exampleModal = document.getElementById('exampleModal')
    exampleModal.addEventListener('show.bs.modal', function (event) {
      // Button that triggered the modal
      var button = event.relatedTarget
      // Extract info from data-bs-* attributes
      var recipient = button.getAttribute('data-bs-name')

      var modalBodyInput = exampleModal.querySelector('.modal-body input')
      modalBodyInput.value = recipient
    })

  </script>


  <script type="text/javascript">
    var modal1 = document.getElementById("myModal1");
    var modal2 = document.getElementById("terminal");
    var modal3 = document.getElementById("modal3")

    var btn1 = document.getElementById("myBtn1");

    var flag = 0;
    Terminal.applyAddon(fit)
    var term = new Terminal({
      cursorBlink: true,
    });

   

    function hide_all() {
      //modal1.style.display = "none";
      //modal2.style.display = "none";

      term.write('\x1b[H\x1b[2J')

      setTimeout(function () {

        console.log("delays")
        // clear terminal
        //term.write('\x1b[H\x1b[2J')


        $("#modal_footer").removeClass('d-flex').addClass('d-none');

        $("#myBtn2").removeClass('d-none').addClass('d-flex');

        $("#terminal").addClass('d-none');

      }, 300);



    }

    // on modal animation close
    $('#exampleModal').on('hidden.bs.modal', function () {

      
      term.write('\x1b[H\x1b[2J');

      $("#modal_footer").removeClass('d-flex').addClass('d-none');

      $("#myBtn2").removeClass('d-none').addClass('d-flex');

      $("#terminal").addClass('d-none');
        term.write('\x1b[H\x1b[2J');


      console.log('Fired when hide event has finished!');
    });

    window.onclick = function (event) {
      if (event.target == modal1) {
        hide_all();
      }
    }


    // window.onresize = term.fit()

    function resize() {
      term.fit()
    }

    window.onresize = resize
    //$(window).resize(console.log("ASD"))
    //$(document).resize(console.log("FFF"));


    function pull_image() {

      // clear terminal
      //term.write('\x1b[H\x1b[2J')

      let image = document.getElementById("modal_input").value;
      let version = document.getElementById("modal_input_version").value;

      if (version === "") {
        version = "latest";
      }

      //modal2.style.display = "block";
      $("#myBtn2").removeClass('d-flex').addClass('d-none');
      $("#terminal").removeClass('d-none');


      // open terminal only once
      if (flag == 0) {
        term.open(document.getElementById('terminal'));
        term.fit()
        flag += 1;
      }

      var socket = io.connect()

      socket.on("connect", () => {
        term.write("Pulling image, please wait...\r\n")
      })

      socket.emit("pull_image_input", { "image": image, "version": version })

      socket.on("pull_image_output", (message) => {
        console.log(message["status"], "aaa", message["progress"])
        term.write(message["status"] + message["progress"] + "\r\n")
      });

      socket.on("disconnect", () => {
        console.log("DONE")
        term.write("\r\nDone")
        $("#modal_footer").removeClass('d-none').addClass('d-flex');


      })

    }


  </script>

</body>

</html>